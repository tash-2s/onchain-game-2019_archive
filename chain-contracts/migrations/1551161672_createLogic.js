const helper = require("../migrationHelper")

const Logic = helper.buildContract(artifacts, "Logic", {
  abi: [
    {
      constant: true,
      inputs: [],
      name: "userNormalPlanet",
      outputs: [
        {
          name: "",
          type: "address"
        }
      ],
      payable: false,
      stateMutability: "view",
      type: "function"
    },
    {
      constant: true,
      inputs: [],
      name: "normalPlanet",
      outputs: [
        {
          name: "",
          type: "address"
        }
      ],
      payable: false,
      stateMutability: "view",
      type: "function"
    },
    {
      constant: true,
      inputs: [],
      name: "gold",
      outputs: [
        {
          name: "",
          type: "address"
        }
      ],
      payable: false,
      stateMutability: "view",
      type: "function"
    },
    {
      inputs: [
        {
          name: "goldContractAddress",
          type: "address"
        },
        {
          name: "normalPlanetContractAddress",
          type: "address"
        },
        {
          name: "userNormalPlanetContractAddress",
          type: "address"
        }
      ],
      payable: false,
      stateMutability: "nonpayable",
      type: "constructor"
    },
    {
      constant: false,
      inputs: [
        {
          name: "planetId",
          type: "uint16"
        },
        {
          name: "axialCoordinateQ",
          type: "int16"
        },
        {
          name: "axialCoordinateR",
          type: "int16"
        }
      ],
      name: "setPlanet",
      outputs: [],
      payable: false,
      stateMutability: "nonpayable",
      type: "function"
    },
    {
      constant: false,
      inputs: [
        {
          name: "userNormalPlanetId",
          type: "uint16"
        }
      ],
      name: "rankupUserNormalPlanet",
      outputs: [],
      payable: false,
      stateMutability: "nonpayable",
      type: "function"
    }
  ],
  bytecode:
    "0x608060405234801561001057600080fd5b50604051606080611d39833981018060405281019080805190602001909291908051906020019092919080519060200190929190505050826000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555081600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505050611c1e8061011b6000396000f30060806040526004361061006d576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680631866e1ff146100725780631e8a1485146100bd5780638720afd0146100ee578063ad83594014610145578063fbec6f211461019c575b600080fd5b34801561007e57600080fd5b506100bb600480360381019080803561ffff169060200190929190803560010b9060200190929190803560010b90602001909291905050506101f3565b005b3480156100c957600080fd5b506100ec600480360381019080803561ffff16906020019092919050505061085d565b005b3480156100fa57600080fd5b506101036111e0565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561015157600080fd5b5061015a611206565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b3480156101a857600080fd5b506101b161122c565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6000600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663ef07e91a856040518263ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808261ffff1661ffff168152602001915050606060405180830381600087803b15801561028e57600080fd5b505af11580156102a2573d6000803e3d6000fd5b505050506040513d60608110156102b857600080fd5b81019080805190602001909291908051906020019092919080519060200190929190505050925050506000600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166370a08231336040518263ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001915050602060405180830381600087803b1580156103a057600080fd5b505af11580156103b4573d6000803e3d6000fd5b505050506040513d60208110156103ca57600080fd5b81019080805190602001909291905050501480156104f9575060008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166370a08231336040518263ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001915050602060405180830381600087803b1580156104a157600080fd5b505af11580156104b5573d6000803e3d6000fd5b505050506040513d60208110156104cb57600080fd5b810190808051906020019092919050505078ffffffffffffffffffffffffffffffffffffffffffffffffff16145b1561063a576000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663dd774eef33610562600a8578ffffffffffffffffffffffffffffffffffffffffffffffffff16611251565b6040518363ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018278ffffffffffffffffffffffffffffffffffffffffffffffffff1678ffffffffffffffffffffffffffffffffffffffffffffffffff16815260200192505050600060405180830381600087803b15801561061d57600080fd5b505af1158015610631573d6000803e3d6000fd5b50505050610756565b61064333611272565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663752caf6b33836040518363ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018278ffffffffffffffffffffffffffffffffffffffffffffffffff1678ffffffffffffffffffffffffffffffffffffffffffffffffff16815260200192505050600060405180830381600087803b15801561073d57600080fd5b505af1158015610751573d6000803e3d6000fd5b505050505b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166363c03899338686866040518563ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018461ffff1661ffff1681526020018360010b60010b81526020018260010b60010b8152602001945050505050600060405180830381600087803b15801561083f57600080fd5b505af1158015610853573d6000803e3d6000fd5b5050505050505050565b606060008060008061086e33611272565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16638dedb01333886040518363ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018261ffff1661ffff16815260200192505050600060405180830381600087803b15801561093b57600080fd5b505af115801561094f573d6000803e3d6000fd5b505050506040513d6000823e3d601f19601f82011682018060405250602081101561097957600080fd5b81019080805164010000000081111561099157600080fd5b828101905060208101848111156109a757600080fd5b81518560208202830111640100000000821117156109c457600080fd5b5050929190505050945073__UserNormalPlanetArrayReader___________63f652a8378660006040518363ffffffff167c01000000000000000000000000000000000000000000000000000000000281526004018080602001838152602001828103825284818151815260200191508051906020019060200280838360005b83811015610a5f578082015181840152602081019050610a44565b50505050905001935050505060206040518083038186803b158015610a8357600080fd5b505af4158015610a97573d6000803e3d6000fd5b505050506040513d6020811015610aad57600080fd5b810190808051906020019092919050505073__Util__________________________________63260348a06040518163ffffffff167c010000000000000000000000000000000000000000000000000000000002815260040160206040518083038186803b158015610b1e57600080fd5b505af4158015610b32573d6000803e3d6000fd5b505050506040513d6020811015610b4857600080fd5b81019080805190602001909291905050500364ffffffffff1693508373__UserNormalPlanetArrayReader___________63edbc51248760006040518363ffffffff167c01000000000000000000000000000000000000000000000000000000000281526004018080602001838152602001828103825284818151815260200191508051906020019060200280838360005b83811015610bf5578082015181840152602081019050610bda565b50505050905001935050505060206040518083038186803b158015610c1957600080fd5b505af4158015610c2d573d6000803e3d6000fd5b505050506040513d6020811015610c4357600080fd5b810190808051906020019092919050505003925060008313151515610cd0576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260188152602001807f6e656564206d6f72652074696d6520746f2072616e6b7570000000000000000081525060200191505060405180910390fd5b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663ef07e91a73__UserNormalPlanetArrayReader___________63df01ce728860006040518363ffffffff167c01000000000000000000000000000000000000000000000000000000000281526004018080602001838152602001828103825284818151815260200191508051906020019060200280838360005b83811015610d9f578082015181840152602081019050610d84565b50505050905001935050505060206040518083038186803b158015610dc357600080fd5b505af4158015610dd7573d6000803e3d6000fd5b505050506040513d6020811015610ded57600080fd5b81019080805190602001909291905050506040518263ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808261ffff1661ffff168152602001915050606060405180830381600087803b158015610e5857600080fd5b505af1158015610e6c573d6000803e3d6000fd5b505050506040513d6060811015610e8257600080fd5b810190808051906020019092919080519060200190929190805190602001909291905050509350505073__UserNormalPlanetArrayReader___________632ae812f18660006040518363ffffffff167c01000000000000000000000000000000000000000000000000000000000281526004018080602001838152602001828103825284818151815260200191508051906020019060200280838360005b83811015610f3c578082015181840152602081019050610f21565b50505050905001935050505060206040518083038186803b158015610f6057600080fd5b505af4158015610f74573d6000803e3d6000fd5b505050506040513d6020811015610f8a57600080fd5b810190808051906020019092919050505060058378ffffffffffffffffffffffffffffffffffffffffffffffffff16811515610fc257fe5b0478ffffffffffffffffffffffffffffffffffffffffffffffffff160290506000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663752caf6b33836040518363ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018278ffffffffffffffffffffffffffffffffffffffffffffffffff1678ffffffffffffffffffffffffffffffffffffffffffffffffff16815260200192505050600060405180830381600087803b1580156110db57600080fd5b505af11580156110ef573d6000803e3d6000fd5b50505050600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663bf87c19133886040518363ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018261ffff1661ffff16815260200192505050600060405180830381600087803b1580156111c057600080fd5b505af11580156111d4573d6000803e3d6000fd5b50505050505050505050565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60008083831115151561126357600080fd5b82840390508091505092915050565b60008060606000806000806000965060009550600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166379e1a00c896040518263ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001915050600060405180830381600087803b15801561134257600080fd5b505af1158015611356573d6000803e3d6000fd5b505050506040513d6000823e3d601f19601f82011682018060405250602081101561138057600080fd5b81019080805164010000000081111561139857600080fd5b828101905060208101848111156113ae57600080fd5b81518560208202830111640100000000821117156113cb57600080fd5b50509291905050509450600093505b73__UserNormalPlanetArrayReader___________632709b0ac866040518263ffffffff167c01000000000000000000000000000000000000000000000000000000000281526004018080602001828103825283818151815260200191508051906020019060200280838360005b83811015611463578082015181840152602081019050611448565b505050509050019250505060206040518083038186803b15801561148657600080fd5b505af415801561149a573d6000803e3d6000fd5b505050506040513d60208110156114b057600080fd5b810190808051906020019092919050505084101561192657600173__UserNormalPlanetArrayReader___________62b7cc7e87876040518363ffffffff167c01000000000000000000000000000000000000000000000000000000000281526004018080602001838152602001828103825284818151815260200191508051906020019060200280838360005b8381101561155957808201518184015260208101905061153e565b50505050905001935050505060206040518083038186803b15801561157d57600080fd5b505af4158015611591573d6000803e3d6000fd5b505050506040513d60208110156115a757600080fd5b810190808051906020019092919050505060ff1614156116b95773__UserNormalPlanetArrayReader___________63f210912086866040518363ffffffff167c01000000000000000000000000000000000000000000000000000000000281526004018080602001838152602001828103825284818151815260200191508051906020019060200280838360005b83811015611651578082015181840152602081019050611636565b50505050905001935050505060206040518083038186803b15801561167557600080fd5b505af4158015611689573d6000803e3d6000fd5b505050506040513d602081101561169f57600080fd5b810190808051906020019092919050505087019650611919565b600273__UserNormalPlanetArrayReader___________62b7cc7e87876040518363ffffffff167c01000000000000000000000000000000000000000000000000000000000281526004018080602001838152602001828103825284818151815260200191508051906020019060200280838360005b8381101561174a57808201518184015260208101905061172f565b50505050905001935050505060206040518083038186803b15801561176e57600080fd5b505af4158015611782573d6000803e3d6000fd5b505050506040513d602081101561179857600080fd5b810190808051906020019092919050505060ff1614156118aa5773__UserNormalPlanetArrayReader___________63f210912086866040518363ffffffff167c01000000000000000000000000000000000000000000000000000000000281526004018080602001838152602001828103825284818151815260200191508051906020019060200280838360005b83811015611842578082015181840152602081019050611827565b50505050905001935050505060206040518083038186803b15801561186657600080fd5b505af415801561187a573d6000803e3d6000fd5b505050506040513d602081101561189057600080fd5b810190808051906020019092919050505086019550611918565b6040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252600e8152602001807f756e646566696e6564206b696e6400000000000000000000000000000000000081525060200191505060405180910390fd5b5b83806001019450506113da565b85870292506000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663d3e15b6f896040518263ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001915050602060405180830381600087803b1580156119e757600080fd5b505af11580156119fb573d6000803e3d6000fd5b505050506040513d6020811015611a1157600080fd5b810190808051906020019092919050505073__Util__________________________________63260348a06040518163ffffffff167c010000000000000000000000000000000000000000000000000000000002815260040160206040518083038186803b158015611a8257600080fd5b505af4158015611a96573d6000803e3d6000fd5b505050506040513d6020811015611aac57600080fd5b81019080805190602001909291905050500391508164ffffffffff16830290506000811115611be8576000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663dd774eef89836040518363ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018278ffffffffffffffffffffffffffffffffffffffffffffffffff1678ffffffffffffffffffffffffffffffffffffffffffffffffff16815260200192505050600060405180830381600087803b158015611bcf57600080fd5b505af1158015611be3573d6000803e3d6000fd5b505050505b50505050505050505600a165627a7a723058201116588b2a78f0e52b6d175a87988066b890be2b00cef52e54b6fff5829168890029"
})

const minterAdditionAbi = [
  {
    constant: false,
    inputs: [
      {
        name: "account",
        type: "address"
      }
    ],
    name: "addMinter",
    outputs: [],
    payable: false,
    stateMutability: "nonpayable",
    type: "function"
  }
]

module.exports = function(deployer, network, accounts) {
  deployer.then(async function() {
    const utilAddress = await helper.getRegistryContractAddress(deployer.network_id, "Util")
    const readerAddress = await helper.getRegistryContractAddress(
      deployer.network_id,
      "UserNormalPlanetArrayReader"
    )
    Logic.setNetwork(deployer.network_id)
    Logic.link("Util", utilAddress)
    Logic.link("UserNormalPlanetArrayReader", readerAddress)

    const goldAddress = await helper.getRegistryContractAddress(deployer.network_id, "Gold")
    const normalPlanetAddress = await helper.getRegistryContractAddress(deployer.network_id, "NormalPlanet")
    const userNormalPlanetAddress = await helper.getRegistryContractAddress(
      deployer.network_id,
      "UserNormalPlanet"
    )

    const logic = await helper.deployAndRegister(deployer, network, Logic, [
      goldAddress,
      normalPlanetAddress,
      userNormalPlanetAddress
    ])

    const Gold = new web3.eth.Contract(minterAdditionAbi, goldAddress)
    await Gold.methods.addMinter(logic.address).send({ from: accounts[0] }) // TODO: 0 is right?
    const UserNormalPlanet = new web3.eth.Contract(minterAdditionAbi, userNormalPlanetAddress)
    await UserNormalPlanet.methods.addMinter(logic.address).send({ from: accounts[0] })
  })
}
